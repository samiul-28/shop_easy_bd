<h1 class="mb-4 text-center"><%= t('products.index.title') %></h1>

<!-- Filter form: Auto-submit on category change -->
<div class="mb-4">
  <%= form_with url: products_path, method: :get, local: true, id: "product-filter-form" do %>
    <div class="row justify-content-center">
      <div class="col-md-4">
        <%= select_tag :category_id,
          options_from_collection_for_select(Category.all, :id, :name_en, @category_id),
          include_blank: "All Categories",
          class: "form-select",
          onchange: "this.form.submit();"
        %>
      </div>
    </div>
  <% end %>
</div>

<div class="row g-4">
  <% @products.each do |product| %>
    <div class="col-sm-6 col-md-4 col-lg-3">
      <div class="card h-100 shadow-sm border-0">
        <% if product.image.attached? %>
          <%= link_to product_path(product) do %>
            <%= image_tag product.image, class: "card-img-top", style: "height:220px; object-fit:cover;" %>
          <% end %>
        <% end %>
        <div class="card-body d-flex flex-column">
          <h5 class="card-title mb-1 text-truncate">
            <%= I18n.locale == :bn ? product.name_bn : product.name_en %>
          </h5>
          <% avg = product.reviews.average(:rating)&.round || 0 %>
          <div class="mb-1">
            <% 5.times do |i| %>
              <% if i < avg %>
                <i class="bi bi-star-fill text-warning"></i>
              <% else %>
                <i class="bi bi-star text-muted"></i>
              <% end %>
            <% end %>
          </div>
          <p class="card-text mb-2">à§³ <%= product.price %></p>
          <%= button_to 'Add to cart',
              cart_items_path(product_id: product.id),
              method: :post,
              class: "btn btn-success mt-auto w-100" %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<% if @products.empty? %>
  <div class="alert alert-info text-center mt-4">
    <%= t('products.index.no_products') %>
  </div>
<% end %>
